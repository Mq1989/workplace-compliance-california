# AGENTS.md — Operational Guidelines for SafeWorkCA

## Build & Run
- `npm run dev` — Start the Next.js development server
- `npm run build` — Production build
- `npm run start` — Start production server

## Validation
- `npm run lint` — Run ESLint
- Tests: TBD (update this section when a test framework is added)

## Operational Notes
- **Next.js version**: 16.1.6 (not 14.x as in PRD). Uses Turbopack by default.
- **React version**: 19.2.3
- **Tailwind CSS v4** (not v3): Uses `@import "tailwindcss"` syntax, `@theme inline` blocks for theme registration, `@plugin` for plugins, `@custom-variant` for dark mode. No `tailwind.config.js` file needed.
- **ESLint 9** with flat config (`eslint.config.mjs`), not legacy `.eslintrc`.
- **Build warning**: Turbopack warns about multiple lockfiles (root + my-app). Not blocking but may need `turbopack.root` config later.
- **shadcn/ui theming**: Uses oklch color space CSS variables mapped via `@theme inline` in `globals.css`. All colors defined as `--color-*` Tailwind theme tokens.
- **Environment variables**: Template in `.env.example`. Clerk, MongoDB, Stripe, Resend, Vercel Blob all need keys before auth/db tasks. A `.env.local` with a valid-format `pk_test_` key is required for `npm run build` to succeed (Clerk validates key format at build time during static page prerendering).
- **Next.js 16 proxy convention**: `middleware.js` is deprecated in Next.js 16. Use `proxy.js` at project root instead. The API is identical — same `clerkMiddleware`, `createRouteMatcher` imports from `@clerk/nextjs/server`. Clerk v6 supports this naming natively.

## Codebase Patterns
- **Class merging**: Use `cn()` from `@/lib/utils` for conditional Tailwind classes (wraps clsx + tailwind-merge).
- **Path aliases**: `@/*` maps to project root via `jsconfig.json`.
- **Dark mode**: Class-based via `@custom-variant dark (&:is(.dark *))`. Toggle on `<html class="dark">`.
- **Component library**: Radix UI primitives installed for building shadcn/ui-style components in `components/ui/`.
- **Constants**: All enums, industry hazard data, and subscription plan definitions live in `constants/index.js`. Import from `@/constants` using named exports.
- **MongoDB**: Connection singleton in `lib/db.js`. Uses global cache (`global.mongoose`) to avoid multiple connections during Next.js hot reloading. Import as `import dbConnect from '@/lib/db'` and call `await dbConnect()` at the start of every API route handler. Requires `MONGODB_URI` in `.env.local` (template in `.env.example`). Mongoose v9 is installed — note that pre middleware no longer receives `next()` (use async functions instead).
- **UI components**: All shadcn/ui primitives live in `components/ui/`. Import like `import { Button } from "@/components/ui/button"`. Components that use Radix interactivity (Select, Checkbox, Switch, Tabs, Dialog, Toast, Progress, RadioGroup, Separator, DropdownMenu) are marked `"use client"`. Button, Input, Label, Card, Textarea are server-compatible (no `"use client"` directive). Also includes a Textarea component as a bonus beyond the original 14.
- **Clerk auth**: `@clerk/nextjs` v6.37.0. `ClerkProvider` wraps `<html>` in root `app/layout.js`. Auth pages use catch-all routes at `app/(auth)/sign-in/[[...sign-in]]/page.js` and `app/(auth)/sign-up/[[...sign-up]]/page.js`. Route protection via `proxy.js` using `clerkMiddleware` + `createRouteMatcher`. Public routes: `/`, `/sign-in(.*)`, `/sign-up(.*)`, `/api/webhooks(.*)`, `/api/cron(.*)`. Import `auth` from `@clerk/nextjs/server` for server-side auth checks in API routes.
- **Mongoose models**: All 6 models live in `lib/models/`. Import like `import Organization from '@/lib/models/Organization'`. Models use the `mongoose.models.X || mongoose.model('X', schema)` pattern to avoid re-compilation during hot reloading. Sub-schemas (ResponsiblePerson, HazardAssessment) are defined inline in `Plan.js`. The Incident model has a `location.type` field — when querying, be careful with Mongoose's `type` keyword collision (it's handled via explicit object nesting).
- **Dashboard layout**: `app/(dashboard)/layout.js` is a `"use client"` component providing sidebar navigation + top bar with Clerk `UserButton`. Sidebar uses lucide-react icons. Mobile responsive with hamburger menu overlay. All dashboard pages go under `app/(dashboard)/` route group. Dashboard home is at `/dashboard` (not `/`) to avoid conflicting with the marketing landing page at `app/page.js`.
- **Route conflict**: `app/page.js` (marketing landing) and `app/(dashboard)/page.js` cannot coexist — both resolve to `/`. Dashboard home is placed at `app/(dashboard)/dashboard/page.js` → `/dashboard`. All sidebar nav links use absolute paths (`/dashboard`, `/plans`, `/training`, etc.).
- **Marketing landing page**: `app/page.js` is a server component (no `"use client"`). Uses `Button` and `Card` from shadcn/ui, `SUBSCRIPTION_PLANS` from constants, and lucide-react icons. Links to `/sign-in` and `/sign-up` for auth. Includes legal disclaimer in footer as required by PRD Section 16.
- **API route pattern**: All API routes live under `app/api/`. Each route file exports async handler functions (`GET`, `POST`, `PUT`, `DELETE`). Pattern: (1) `await auth()` from `@clerk/nextjs/server` — destructure `{ userId, orgId }`, (2) guard with `if (!userId)` → 401, (3) `await dbConnect()`, (4) look up org via `Organization.findOne({ clerkOrgId: orgId || userId })`, (5) perform operation, (6) return `NextResponse.json(...)`. First API route created: `app/api/organizations/route.js` (GET + POST).
- **Onboarding flow**: `app/(dashboard)/onboarding/page.js` is a `"use client"` multi-step form (4 steps: Company Info, Address, Industry, Workforce). Uses local `useState` for form data — no react-hook-form needed for this simple wizard. POSTs to `/api/organizations` on completion and redirects to `/plans/new`. Workplace type uses Checkbox multi-select. State field is locked to CA. Step indicators are clickable for previous steps only.
- **Plans API**: Three route files under `app/api/plans/`. `route.js` handles GET (list all for org) and POST (create). `[planId]/route.js` handles GET (single plan) and PUT (update with `$set`). `[planId]/publish/route.js` handles POST — archives all existing active plans first, then sets the target plan to `active` with `$inc: { version: 1 }`, and updates the organization's compliance tracking dates (`wvppCreatedAt`, `lastPlanReviewDate`, `nextPlanReviewDueDate`). All three files create `AuditLog` entries. Dynamic route params use `const { planId } = await params` per Next.js 16 convention.
- **Plans list page**: `app/(dashboard)/plans/page.js` is a `"use client"` component. Fetches from `/api/plans` with `useEffect`. Displays plans as Card rows with StatusBadge (draft=yellow, active=green, archived=muted). Shows empty state with CTA when no plans exist. Each card shows version, creation/publish dates, responsible persons count, hazard count, and a "View Plan" link to `/plans/[id]`.
- **PlanWizard (full, Steps 1-11)**: `components/forms/PlanWizard.js` is a `"use client"` 11-step wizard covering the complete WVPP creation flow. Steps: (1) Responsible Persons, (2) Employee Involvement + Compliance, (3) Communication System, (4) Emergency Response, (5) Hazard Assessment, (6) Post-Incident Procedures (hazard correction + investigation), (7) Training Program (descriptions + topic checklist from `TRAINING_TOPICS`), (8) Recordkeeping & Access (retention periods with min-value selectors + plan accessibility), (9) Review Schedule (annual month picker), (10) Authorization (e-signature with name/title/agreement checkbox), (11) Review & Publish (summary of all sections with per-section Edit buttons). Uses `useState` for `formData` and `step`, per-step validation via `validateStep()`, progress bar with compact step indicators. Accepts `industry` prop (pre-populates hazards) and `existingPlan` prop (edit mode). Save Draft POSTs to `/api/plans`. Publish flow: saves draft then calls `/api/plans/[id]/publish`. `SummarySection` is a small helper component for the review step. The `buildPayload()` helper strips the UI-only `agreed` field from authorization before submission. Default investigation steps and support resources are provided as constants.
- **Plans new page**: `app/(dashboard)/plans/new/page.js` fetches the org from `/api/organizations` to get the `industry` field, then renders `<PlanWizard industry={industry} />`. Shows a loading spinner while fetching. If org fetch fails, wizard still works (just no hazard pre-population).
- **Plan detail page**: `app/(dashboard)/plans/[planId]/page.js` is a `"use client"` component. Fetches plan from `/api/plans/[planId]` and org from `/api/organizations` in parallel. Displays all 11 WVPP sections in read-only cards (Section, DetailRow, TagList, BooleanIndicator helpers). Has an "Edit Plan" button that swaps to `<PlanWizard existingPlan={plan} industry={industry} />` — note the PlanWizard `existingPlan` prop pre-fills all form fields. Draft plans show a Publish button that POSTs to `/api/plans/[planId]/publish`. Status badges and date formatting reuse the same patterns as the plans list page. The `useParams()` hook provides `planId`.
- **PDF generation**: `lib/pdf/generateWVPP.js` uses jsPDF v4 to generate a full WVPP PDF. Exports `generateWVPP(plan, organization)` which returns a Node.js `Buffer`. The plan and organization objects must be plain objects (use `.toObject()` on Mongoose documents). The PDF includes a title page, 10 content sections matching all LC 6401.9 requirements, page numbers, and footer. Helper functions (`ensureSpace`, `sectionHeading`, `subHeading`, `labeledLine`, `bodyText`, `bulletList`, `boolLine`) manage layout and automatic page breaks. Uses `VIOLENCE_TYPES` and `ALERT_METHODS` from constants for label lookups.
- **PDF export API**: `GET /api/plans/[planId]/pdf` returns a binary PDF response with `Content-Type: application/pdf` and `Content-Disposition: attachment`. Uses raw `Response` (not `NextResponse.json`) for binary data. Creates an `AuditLog` entry with action `pdf_generated`. The filename is sanitized from the organization name (strips non-alphanumeric chars).
