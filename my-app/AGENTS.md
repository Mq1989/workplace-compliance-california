# AGENTS.md — Operational Guidelines for SafeWorkCA

## Build & Run
- `npm run dev` — Start the Next.js development server
- `npm run build` — Production build
- `npm run start` — Start production server

## Validation
- `npm run lint` — Run ESLint
- Tests: TBD (update this section when a test framework is added)

## Operational Notes
- **Next.js version**: 16.1.6 (not 14.x as in PRD). Uses Turbopack by default.
- **React version**: 19.2.3
- **Tailwind CSS v4** (not v3): Uses `@import "tailwindcss"` syntax, `@theme inline` blocks for theme registration, `@plugin` for plugins, `@custom-variant` for dark mode. No `tailwind.config.js` file needed.
- **ESLint 9** with flat config (`eslint.config.mjs`), not legacy `.eslintrc`.
- **Build warning**: Turbopack warns about multiple lockfiles (root + my-app). Not blocking but may need `turbopack.root` config later.
- **shadcn/ui theming**: Uses oklch color space CSS variables mapped via `@theme inline` in `globals.css`. All colors defined as `--color-*` Tailwind theme tokens.
- **Environment variables**: Template in `.env.example`. Clerk, MongoDB, Stripe, Resend, Vercel Blob all need keys before auth/db tasks. A `.env.local` with a valid-format `pk_test_` key is required for `npm run build` to succeed (Clerk validates key format at build time during static page prerendering).
- **Next.js 16 proxy convention**: `middleware.js` is deprecated in Next.js 16. Use `proxy.js` at project root instead. The API is identical — same `clerkMiddleware`, `createRouteMatcher` imports from `@clerk/nextjs/server`. Clerk v6 supports this naming natively.

## Codebase Patterns
- **Class merging**: Use `cn()` from `@/lib/utils` for conditional Tailwind classes (wraps clsx + tailwind-merge).
- **Path aliases**: `@/*` maps to project root via `jsconfig.json`.
- **Dark mode**: Class-based via `@custom-variant dark (&:is(.dark *))`. Toggle on `<html class="dark">`.
- **Component library**: Radix UI primitives installed for building shadcn/ui-style components in `components/ui/`.
- **Constants**: All enums, industry hazard data, and subscription plan definitions live in `constants/index.js`. Import from `@/constants` using named exports.
- **MongoDB**: Connection singleton in `lib/db.js`. Uses global cache (`global.mongoose`) to avoid multiple connections during Next.js hot reloading. Import as `import dbConnect from '@/lib/db'` and call `await dbConnect()` at the start of every API route handler. Requires `MONGODB_URI` in `.env.local` (template in `.env.example`). Mongoose v9 is installed — note that pre middleware no longer receives `next()` (use async functions instead).
- **UI components**: All shadcn/ui primitives live in `components/ui/`. Import like `import { Button } from "@/components/ui/button"`. Components that use Radix interactivity (Select, Checkbox, Switch, Tabs, Dialog, Toast, Progress, RadioGroup, Separator, DropdownMenu) are marked `"use client"`. Button, Input, Label, Card, Textarea are server-compatible (no `"use client"` directive). Also includes a Textarea component as a bonus beyond the original 14.
- **Clerk auth**: `@clerk/nextjs` v6.37.0. `ClerkProvider` wraps `<html>` in root `app/layout.js`. Auth pages use catch-all routes at `app/(auth)/sign-in/[[...sign-in]]/page.js` and `app/(auth)/sign-up/[[...sign-up]]/page.js`. Route protection via `proxy.js` using `clerkMiddleware` + `createRouteMatcher`. Public routes: `/`, `/sign-in(.*)`, `/sign-up(.*)`, `/api/webhooks(.*)`, `/api/cron(.*)`. Import `auth` from `@clerk/nextjs/server` for server-side auth checks in API routes.
- **Mongoose models**: All 6 models live in `lib/models/`. Import like `import Organization from '@/lib/models/Organization'`. Models use the `mongoose.models.X || mongoose.model('X', schema)` pattern to avoid re-compilation during hot reloading. Sub-schemas (ResponsiblePerson, HazardAssessment) are defined inline in `Plan.js`. The Incident model has a `location.type` field — when querying, be careful with Mongoose's `type` keyword collision (it's handled via explicit object nesting).
- **Dashboard layout**: `app/(dashboard)/layout.js` is a `"use client"` component providing sidebar navigation + top bar with Clerk `UserButton`. Sidebar uses lucide-react icons. Mobile responsive with hamburger menu overlay. All dashboard pages go under `app/(dashboard)/` route group. Dashboard home is at `/dashboard` (not `/`) to avoid conflicting with the marketing landing page at `app/page.js`.
- **Route conflict**: `app/page.js` (marketing landing) and `app/(dashboard)/page.js` cannot coexist — both resolve to `/`. Dashboard home is placed at `app/(dashboard)/dashboard/page.js` → `/dashboard`. All sidebar nav links use absolute paths (`/dashboard`, `/plans`, `/training`, etc.).
- **Marketing landing page**: `app/page.js` is a server component (no `"use client"`). Uses `Button` and `Card` from shadcn/ui, `SUBSCRIPTION_PLANS` from constants, and lucide-react icons. Links to `/sign-in` and `/sign-up` for auth. Includes legal disclaimer in footer as required by PRD Section 16.
- **API route pattern**: All API routes live under `app/api/`. Each route file exports async handler functions (`GET`, `POST`, `PUT`, `DELETE`). Pattern: (1) `await auth()` from `@clerk/nextjs/server` — destructure `{ userId, orgId }`, (2) guard with `if (!userId)` → 401, (3) `await dbConnect()`, (4) look up org via `Organization.findOne({ clerkOrgId: orgId || userId })`, (5) perform operation, (6) return `NextResponse.json(...)`. First API route created: `app/api/organizations/route.js` (GET + POST).
- **Onboarding flow**: `app/(dashboard)/onboarding/page.js` is a `"use client"` multi-step form (4 steps: Company Info, Address, Industry, Workforce). Uses local `useState` for form data — no react-hook-form needed for this simple wizard. POSTs to `/api/organizations` on completion and redirects to `/plans/new`. Workplace type uses Checkbox multi-select. State field is locked to CA. Step indicators are clickable for previous steps only.
- **Plans API**: Three route files under `app/api/plans/`. `route.js` handles GET (list all for org) and POST (create). `[planId]/route.js` handles GET (single plan) and PUT (update with `$set`). `[planId]/publish/route.js` handles POST — archives all existing active plans first, then sets the target plan to `active` with `$inc: { version: 1 }`, and updates the organization's compliance tracking dates (`wvppCreatedAt`, `lastPlanReviewDate`, `nextPlanReviewDueDate`). All three files create `AuditLog` entries. Dynamic route params use `const { planId } = await params` per Next.js 16 convention.
- **Plans list page**: `app/(dashboard)/plans/page.js` is a `"use client"` component. Fetches from `/api/plans` with `useEffect`. Displays plans as Card rows with StatusBadge (draft=yellow, active=green, archived=muted). Shows empty state with CTA when no plans exist. Each card shows version, creation/publish dates, responsible persons count, hazard count, and a "View Plan" link to `/plans/[id]`.
- **PlanWizard (full, Steps 1-11)**: `components/forms/PlanWizard.js` is a `"use client"` 11-step wizard covering the complete WVPP creation flow. Steps: (1) Responsible Persons, (2) Employee Involvement + Compliance, (3) Communication System, (4) Emergency Response, (5) Hazard Assessment, (6) Post-Incident Procedures (hazard correction + investigation), (7) Training Program (descriptions + topic checklist from `TRAINING_TOPICS`), (8) Recordkeeping & Access (retention periods with min-value selectors + plan accessibility), (9) Review Schedule (annual month picker), (10) Authorization (e-signature with name/title/agreement checkbox), (11) Review & Publish (summary of all sections with per-section Edit buttons). Uses `useState` for `formData` and `step`, per-step validation via `validateStep()`, progress bar with compact step indicators. Accepts `industry` prop (pre-populates hazards) and `existingPlan` prop (edit mode). Save Draft POSTs to `/api/plans`. Publish flow: saves draft then calls `/api/plans/[id]/publish`. `SummarySection` is a small helper component for the review step. The `buildPayload()` helper strips the UI-only `agreed` field from authorization before submission. Default investigation steps and support resources are provided as constants.
- **Plans new page**: `app/(dashboard)/plans/new/page.js` fetches the org from `/api/organizations` to get the `industry` field, then renders `<PlanWizard industry={industry} />`. Shows a loading spinner while fetching. If org fetch fails, wizard still works (just no hazard pre-population).
- **Plan detail page**: `app/(dashboard)/plans/[planId]/page.js` is a `"use client"` component. Fetches plan from `/api/plans/[planId]` and org from `/api/organizations` in parallel. Displays all 11 WVPP sections in read-only cards (Section, DetailRow, TagList, BooleanIndicator helpers). Has an "Edit Plan" button that swaps to `<PlanWizard existingPlan={plan} industry={industry} />` — note the PlanWizard `existingPlan` prop pre-fills all form fields. Draft plans show a Publish button that POSTs to `/api/plans/[planId]/publish`. Status badges and date formatting reuse the same patterns as the plans list page. The `useParams()` hook provides `planId`.
- **PDF generation**: `lib/pdf/generateWVPP.js` uses jsPDF v4 to generate a full WVPP PDF. Exports `generateWVPP(plan, organization)` which returns a Node.js `Buffer`. The plan and organization objects must be plain objects (use `.toObject()` on Mongoose documents). The PDF includes a title page, 10 content sections matching all LC 6401.9 requirements, page numbers, and footer. Helper functions (`ensureSpace`, `sectionHeading`, `subHeading`, `labeledLine`, `bodyText`, `bulletList`, `boolLine`) manage layout and automatic page breaks. Uses `VIOLENCE_TYPES` and `ALERT_METHODS` from constants for label lookups.
- **PDF export API**: `GET /api/plans/[planId]/pdf` returns a binary PDF response with `Content-Type: application/pdf` and `Content-Disposition: attachment`. Uses raw `Response` (not `NextResponse.json`) for binary data. Creates an `AuditLog` entry with action `pdf_generated`. The filename is sanitized from the organization name (strips non-alphanumeric chars).
- **Dashboard API**: `GET /api/dashboard` returns a single aggregated response with compliance scores, stats, alerts, deadlines, and recent activity. Fetches Organization, Plan (active), Incident, Employee, and AuditLog data in parallel with `Promise.all`. Compliance score is calculated from 4 equal-weight components (25% each): WVPP status, training completion, annual review status, and incident investigation status. The API returns 404 if no organization exists for the user (dashboard page shows onboarding CTA in that case).
- **Dashboard page**: `app/(dashboard)/dashboard/page.js` is a `"use client"` component. Fetches from `/api/dashboard` with `useEffect`. Renders: (1) alert banners (critical red, warning yellow, info blue) at top, (2) compliance score ring (SVG) + score breakdown with Progress bars, (3) quick stats cards (plans, employees, incidents, trained), (4) three-column bottom row with upcoming deadlines, recent activity (with relative timestamps), and quick action buttons. Empty state redirects to `/onboarding`. Uses `cn()` for conditional styling, lucide-react icons throughout.
- **Incidents API**: Two route files under `app/api/incidents/`. `route.js` handles GET (list all for org, with optional `status`, `startDate`, `endDate` query params) and POST (create with audit log). `[incidentId]/route.js` handles GET (single incident) and PUT (update with `$set` + audit log). Same auth/org lookup pattern as Plans API. Incidents are sorted by `incidentDate` descending. AuditLog actions used: `incident_logged` (create) and `incident_updated` (update).
- **Incidents list page**: `app/(dashboard)/incidents/page.js` is a `"use client"` component. Fetches from `/api/incidents` with `useEffect`. Displays incident cards with date/time title, location description subtitle, truncated description (2-line clamp), and three stat columns: violence type, incident type, and perpetrator classification. Uses `lookupLabel()` helper to resolve enum values from `VIOLENCE_TYPES`, `INCIDENT_TYPES`, and `PERPETRATOR_TYPES` constants. Investigation status badge uses three states: pending (yellow), in_progress (blue), completed (green). Empty state shows CTA to log first incident. Links to `/incidents/new` (create) and `/incidents/[id]` (detail).
- **IncidentForm**: `components/forms/IncidentForm.js` is a `"use client"` 6-step wizard for logging workplace violence incidents per LC 6401.9(d). Steps: (1) Date/Time/Location with enum-based location type select, (2) Violence type + incident type (both multi-select checkboxes) + perpetrator classification (single select), (3) Detailed description textarea with PII warning + circumstances checkboxes (8 predefined + other freetext), (4) Security/law enforcement response with Switch toggles and conditional detail fields, (5) Injuries/medical/Cal-OSHA with same switch+conditional pattern, (6) Completed-by name+title with PII reminder banner. Accepts `planId` prop (required by Incident model). Validates required fields per step. On submit POSTs to `/api/incidents` and redirects to `/incidents/[id]`. Uses same progress bar + step indicator pattern as PlanWizard.
- **Incidents new page**: `app/(dashboard)/incidents/new/page.js` fetches all plans from `/api/plans`, finds the active plan (status `"active"`), and passes its `_id` as `planId` to `<IncidentForm>`. Shows error state with CTA to create a WVPP if no active plan exists.
- **Incident detail page**: `app/(dashboard)/incidents/[incidentId]/page.js` is a `"use client"` component. Fetches from `/api/incidents/[incidentId]` with `useEffect`. Displays all incident data in read-only sectioned cards: Date/Time/Location, Classification (violence types + incident types as TagLists, perpetrator as DetailRow), Description & Circumstances, Response & Consequences (BooleanRow with conditional detail text), Injuries & Medical (including Cal/OSHA reporting), and Completed By. Includes an editable Investigation section with status select (pending/in_progress/completed), investigation notes textarea, and corrective actions textarea (one per line). Save updates via PUT to `/api/incidents/[incidentId]`. Follows the same Section/DetailRow/TagList helper pattern as the plan detail page. `useParams()` provides `incidentId`.
- **Employees API**: Two route files under `app/api/employees/`. `route.js` handles GET (list with optional `active`, `role`, `search` query params) and POST (create with audit log). Duplicate email returns 409 (catches Mongoose error code 11000 from the unique compound index on `organizationId + email`). `[employeeId]/route.js` handles GET (single), PUT (update with `$set` + audit log), and DELETE (soft-delete: sets `isActive: false` and `terminationDate: new Date()` + audit log). All three DELETE doesn't hard-remove — it deactivates. Uses `employee_added`, `employee_updated`, and `employee_removed` AuditLog actions. The `employee_updated` action was added to the AuditLog enum (previously missing). Employees sorted by `lastName, firstName` ascending.
- **Employees roster page**: `app/(dashboard)/employees/page.js` is a `"use client"` component. Fetches from `/api/employees` with `useEffect` + `useCallback`. Displays employee cards with name, job title, email, department, hire date, role badge, and active/inactive status badge. Includes search input (filters by name, email, title, department via API `search` param), active/inactive select filter, and role filter select. "Add Employee" button opens a Dialog containing `<EmployeeForm>`. After successful add, dialog closes and list refetches. Employee role configs (label + color class) are defined inline as `ROLE_CONFIG`. Empty state adapts messaging based on whether filters are applied.
- **EmployeeForm**: `components/forms/EmployeeForm.js` is a `"use client"` form component supporting both create and edit modes. Accepts `existingEmployee` prop (prefills all fields for editing), `onSuccess` callback (called with saved employee), and `onCancel` callback. Fields: firstName, lastName, email, phone, department, jobTitle, role (Select), hireDate. Client-side validation checks required fields and email format before submit. POSTs to `/api/employees` (create) or PUTs to `/api/employees/[id]` (edit). Uses the same error display pattern as other forms (red border box). Not a multi-step wizard — single-page form with submit button.
- **Employee detail page**: `app/(dashboard)/employees/[employeeId]/page.js` is a `"use client"` component. Fetches from `/api/employees/[employeeId]` with `useEffect`. Displays read-only sections: Contact Information (email, phone), Employment Details (title, department, role, hire date, termination date if inactive), Training & Compliance (initial training, last annual, next due with overdue warning), WVPP Acknowledgment (date + version with missing-acknowledgment warning), and Record Information (created/updated timestamps). Edit mode swaps the full view for `<EmployeeForm existingEmployee={emp}>` inside a Card. Deactivate button triggers a confirmation Dialog that calls DELETE on the API and redirects to `/employees`. Reuses `ROLE_CONFIG`, `RoleBadge`, `StatusBadge`, `Section`, `DetailRow` helper patterns from the roster and incident detail pages. `useParams()` provides `employeeId`.
- **Training API**: Two route files under `app/api/training/`. `route.js` handles GET (list with optional `employeeId`, `trainingType`, `startDate`, `endDate` query params) and POST (create with audit log + employee training field updates). `[recordId]/route.js` handles GET (single record) and PUT (update with `$set` + audit log). POST verifies that the employee belongs to the organization before creating. On completion, auto-updates the Employee's `initialTrainingCompletedAt`, `lastAnnualTrainingCompletedAt`, and `nextTrainingDueDate` fields (next due = 1 year from completion). Uses `training_completed` AuditLog action. Training records sorted by `trainingDate` descending.
- **Training dashboard page**: `app/(dashboard)/training/page.js` is a `"use client"` component. Fetches employees (`/api/employees?active=true`) and training records (`/api/training`) in parallel with `Promise.all`. Displays: (1) four summary stat cards — training completion % with Progress bar, not started count, overdue count, due-soon count (within 30 days), (2) recent training records list (last 5) with completion status, (3) employee training status list with `TrainingStatusBadge` (Not Started=red, Overdue=red, Due in Xd=yellow, Current=green). Links to `/training/records` for full records view and `/employees/[id]` for individual employee details. Empty state redirects to `/employees` when no employees exist.
- **Training records page**: `app/(dashboard)/training/records/page.js` is a `"use client"` component. Fetches from `/api/training` with `useCallback` for filter reactivity. Filters: employee Select (populated from `/api/employees?active=all`), training type Select (initial/annual/new_hazard/plan_update), and date range (start/end date inputs). Displays records as Cards with module name, employee name (via lookup map), training date, type badge (`TypeBadge` with color-coded backgrounds per type), completion status badge, trainer name, duration, quiz score/pass status, content summary (line-clamped), and acknowledgment info. Back button links to `/training`. Uses same `useCallback` + `useEffect` refetch pattern as the employees roster page.
- **Clerk webhook handler**: `app/api/webhooks/clerk/route.js` is a POST-only route (no auth — verified by svix signature instead). Uses `svix` package (`Webhook` class) to verify webhook signatures against `CLERK_WEBHOOK_SECRET` env var. Reads raw body via `request.text()` and passes svix headers (`svix-id`, `svix-timestamp`, `svix-signature`) for verification. Handles 5 event types: `organizationMembership.created` (links clerkUserId to Employee by email match), `organizationMembership.updated` (syncs email changes), `organizationMembership.deleted` (deactivates Employee), `user.updated` (syncs primary email across all Employee records for that user), `user.deleted` (deactivates all Employee records and clears clerkUserId). Unhandled events return 200 without error. The route is already public in `proxy.js` via the `/api/webhooks(.*)` matcher. `svix` v1.84.1 is a direct dependency.
- **Email service**: `lib/email/sendReminder.js` uses Resend SDK (`resend` v6.9.1, already installed). Exports `sendReminder(type, to, data)` where `type` is one of: `training_due`, `training_overdue`, `training_overdue_admin`, `annual_review`, `incident_followup`. Each type has a subject generator and HTML template function. Requires `RESEND_API_KEY` and optionally `RESEND_FROM_EMAIL` env vars (defaults to `SafeWorkCA <notifications@safeworkca.com>`).
- **Cron reminders route**: `GET /api/cron/reminders` is a public route (matched by `/api/cron(.*)` in `proxy.js`) protected by `Bearer ${CRON_SECRET}` header check. Iterates all organizations, checks: (1) employee training due dates at 30/7/1 day intervals, (2) overdue training at day-of and 7-days-after, (3) annual WVPP review at 30/7 days before, (4) open incident investigations every 7 days. Sends emails via `sendReminder()` and returns a JSON summary with `sent` count, `errors` count, and `details` array. Designed for Vercel Cron (`vercel.json` cron config needed for production deployment).
- **Stripe webhook handler**: `app/api/webhooks/stripe/route.js` is a POST-only route (no auth — verified by Stripe signature). Uses `stripe` SDK v20.3.0 (`getStripe().webhooks.constructEvent()`) to verify signatures against `STRIPE_WEBHOOK_SECRET` env var. Handles 4 event types: `checkout.session.completed` (links Stripe customer/subscription to Organization by `metadata.organizationId`), `customer.subscription.updated` (syncs plan tier and period end; downgrades to free on canceled/unpaid status), `customer.subscription.deleted` (reverts to free tier), `invoice.payment_failed` (logs warning). Maps Stripe price IDs to plan tiers (`starter`, `professional`, `enterprise`) via `STRIPE_STARTER_PRICE_ID`, `STRIPE_PROFESSIONAL_PRICE_ID`, `STRIPE_ENTERPRISE_PRICE_ID` env vars. **Build quirk**: The Stripe client must be lazy-initialized (not at module scope) because `STRIPE_SECRET_KEY` is not available during Next.js static prerendering at build time — `new Stripe(undefined)` throws immediately. Uses a `getStripe()` singleton pattern. The route is public via the `/api/webhooks(.*)` matcher in `proxy.js`. The billing page (Task 11.2) must set `metadata.organizationId` on checkout sessions for the webhook to link subscriptions.
- **Billing API**: `app/api/billing/route.js` provides GET (fetch current plan + live Stripe subscription status) and POST (create Stripe Checkout session or Customer Portal session). POST accepts `{ action: 'checkout', priceId }` or `{ action: 'portal' }`. Checkout sessions set `metadata.organizationId` to link back via webhook. Reuses existing `stripeCustomerId` on Organization if present, otherwise passes `customer_email`. Uses the same `getStripe()` lazy-init pattern as the webhook handler.
- **Billing page**: `app/(dashboard)/billing/page.js` is a `"use client"` component. Displays current plan status with live Stripe subscription info (status badge, renewal/cancel date), plan comparison grid (starter/professional/enterprise from `SUBSCRIPTION_PLANS`), and billing FAQ. Uses `useSearchParams()` for success/canceled redirect banners — **requires Suspense boundary** (Next.js requirement for `useSearchParams` during static prerendering). The page component wraps `BillingContent` in `<Suspense>`. Plan price IDs are read from `NEXT_PUBLIC_STRIPE_STARTER_PRICE_ID`, `NEXT_PUBLIC_STRIPE_PROFESSIONAL_PRICE_ID`, `NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID` client-side env vars. Existing subscribers are directed to Stripe Customer Portal for plan changes; new subscribers use Stripe Checkout.
- **useSearchParams Suspense requirement**: Any `"use client"` page using `useSearchParams()` must wrap the consuming component in a `<Suspense>` boundary. Without it, Next.js build fails during static prerendering with "useSearchParams() should be wrapped in a suspense boundary". Pattern: export default component renders `<Suspense fallback={...}><InnerComponent /></Suspense>`, inner component calls `useSearchParams()`.
- **Settings API**: `app/api/settings/route.js` provides GET (fetch organization) and PUT (update allowed fields with whitelist: `name`, `dba`, `address`, `phone`, `email`, `industry`, `employeeCount`, `workplaceType`). Uses `AuditLog` with action `settings_changed`, `resourceType: 'organization'`. Follows same auth/org lookup pattern as other API routes.
- **Settings page**: `app/(dashboard)/settings/page.js` is a `"use client"` component with two tabs: Organization (editable company info, address, business details with save) and Compliance (read-only compliance dates with status indicators, subscription summary with link to billing, data retention policy per LC 6401.9). Uses custom tab navigation (not shadcn Tabs) — inline `<button>` elements with border-bottom active state. Helper components: `ComplianceField` (label + value + status color), `RetentionRow` (label + period), `getDateStatus()` (calculates overdue/upcoming/complete from date). Empty org state redirects to `/onboarding`.
- **Phase 1 QA status (Task 12.2)**: Build passes, lint clean, all 14 static pages render, all 19 API routes respond correctly. Protected routes redirect to sign-in (307) via Clerk. Public webhook routes return 405 (POST-only). Cron route returns 401 without bearer token. `.env.example` had a leaked Resend API key (now removed). PRD updated to v3.0 with full platform spec for Phase 2+ features (LMS, AI Q&A, anonymous reporting). The codebase is ready for Phase 2 implementation (new data models, employee portal, training LMS).
- **Mongoose models (Phase 2+)**: Now 14 models in `lib/models/`. New models: TrainingModule, TrainingQuestion, TrainingProgress, ChatMessage, AnonymousReport, AnonymousThread, Document, Reminder. All follow the same `mongoose.models.X || mongoose.model('X', schema)` anti-recompilation pattern. AnonymousReport uses Node.js `crypto` for token generation and hashing (`crypto.randomBytes`, `crypto.createHash('sha256')`). Employee model now includes `inviteStatus` enum, `trainingPath` sub-document, and `hasCompletedQA` boolean. Organization model now includes `settings` sub-document (training config, AI Q&A config), `complianceScore` sub-document (cached scores), and `wvppContent` sub-document (for RAG context). AuditLog `action` enum expanded with 16 new action types covering training modules, chat, anonymous reports, documents, and reminders. AuditLog `resourceType` enum expanded with `chat`, `anonymous_report`, `document`, `reminder`, `training_module`.
- **Training seed script**: `lib/seed/trainingModules.js` seeds 6 default SB 553 training modules and 30 quiz questions (5 per module). Run with `node --env-file=.env.local lib/seed/trainingModules.js`. Idempotent — skips modules whose `moduleId` already exists. Modules follow the sequential order from PRD §5.2: (1) wvpp-overview-v1, (2) reporting-procedures-v1, (3) hazard-recognition-v1, (4) avoidance-strategies-v1, (5) incident-log-v1, (6) emergency-response-v1. Questions use three types: `multiple_choice`, `true_false`, `select_all`. Each question includes an `explanation` field for post-answer feedback. The script connects directly to MongoDB (not via `lib/db.js`) since it runs outside the Next.js runtime.
- **Portal layout**: `app/(portal)/layout.js` is a `"use client"` component providing employee-focused sidebar navigation + top bar with Clerk `UserButton`. Follows the same structural pattern as the dashboard layout (sidebar with mobile overlay, top bar, scrollable main area). Nav items: Home (`/portal`), Training, Q&A, WVPP, Documents. Includes an "Employee Portal" label in the sidebar. Portal routes are protected by the existing `auth.protect()` in `proxy.js` — no public route additions needed. The `(portal)` route group keeps portal pages separate from `(dashboard)` admin pages.
- **Portal dashboard page**: `app/(portal)/portal/page.js` is a `"use client"` component. Fetches from `/api/portal/dashboard` with `useEffect`. Displays: (1) welcome header with employee name and org name, (2) training progress card with overall progress bar and sequential module list showing locked/unlocked/in-progress/completed states, (3) "Continue Training" button for the next module, (4) quick link cards grid (Training, Q&A, WVPP, Documents). Sequential locking logic: module N is locked unless module N-1 is completed. Uses `STATUS_CONFIG` map and `ModuleStatusIcon` helper for consistent status rendering.
- **Portal dashboard API**: `GET /api/portal/dashboard` identifies the current employee by `clerkUserId` from `auth()`, fetches `TrainingModule` (active, sorted by order) and `TrainingProgress` records, and returns employee info, organization name, and training summary (module progress list, counts, overall percentage, next module). Returns 404 if employee record not found (e.g., admin users without employee records). Uses the same auth/dbConnect pattern as other API routes.
- **Welcome page**: `app/(portal)/portal/welcome/page.js` is a `"use client"` component for post-invite landing. Located at `/portal/welcome` (matching the Clerk invite `redirectUrl` in PRD §2.3). Reuses the existing `/api/portal/dashboard` endpoint — no new API needed. Displays personalized greeting, three onboarding steps (training, WVPP review, Q&A) in a vertical timeline layout, account setup confirmation, and CTA buttons to start training or go to portal home. Follows the same loading/error/not-found patterns as the portal dashboard page. Centered layout with `max-w-2xl` for focused onboarding feel.
- **LMS API routes (Task 15.1)**: Eight new routes under `app/api/training/`. (1) `modules/route.js` — GET lists active modules sorted by order. (2) `modules/[moduleId]/route.js` — GET returns module details + quiz questions with correct answers stripped (security: answers only used server-side for grading). (3) `progress/route.js` — GET returns employee's TrainingProgress records; supports optional `employeeId` query param for admin lookups. (4) `progress/video/route.js` — POST updates video watch progress; only allows forward progress (can't go backward); auto-marks video complete at ≥90%; creates TrainingProgress record on first interaction and sets employee `trainingPath.startedAt`. (5) `progress/quiz/route.js` — POST grades quiz submission server-side; supports `multiple_choice`, `true_false`, and `select_all` question types; returns graded answers with explanations and correct option IDs; updates bestScore, quizPassed, and module completion status (video + quiz = complete); increments module `totalCompletions` on completion; creates AuditLog with `quiz_submitted` action. (6) `complete/route.js` — POST verifies all required modules completed, creates a TrainingRecord for compliance, updates employee training dates (initial/annual + next due 1 year out); returns training record + next due date. (7) `assign/route.js` — POST creates TrainingProgress records for employee/module combos (skips existing); accepts `employeeIds` array and optional `dueDate`; creates AuditLog with `training_assigned` action. (8) `reports/route.js` — GET returns comprehensive admin report with per-employee module breakdowns, summary stats (fullyTrained, inProgress, notStarted, overdue, completionRate). **Lint quirk**: Do NOT name a variable `module` in Next.js API routes — the `@next/next/no-assign-module-variable` ESLint rule forbids it. Use `trainingModule` instead.
